<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --text-main: #c5c6c7;
            --text-highlight: #66fcf1;
            --accent-gold: #d4a76a;
            --accent-glow: rgba(212, 167, 106, 0.4);
            --success: #2ecc71;
            --danger: #e74c3c;
            --bg-card: rgba(31, 40, 51, 0.95);
            --border: rgba(255, 255, 255, 0.1);
        }

        html, body {
            margin: 0; padding: 5px;
            padding-bottom: 20px;
            font-family: 'Noto Sans TC', sans-serif;
            background: transparent;
            color: var(--text-main);
            min-height: 100%;
            overflow: visible;
        }
        * { box-sizing: border-box; }

        .tech-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 30px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        .tech-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent); opacity: 0.7;
        }
        .card-title {
            font-size: 1.4em; color: var(--accent-gold); border-left: 4px solid var(--accent-gold);
            padding-left: 15px; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 2px; font-weight: bold;
        }
        .grid-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .grid-col { flex: 1; }
        label {
            display: block; margin-bottom: 8px; color: var(--accent-gold);
            font-size: 0.85em; font-family: 'Rajdhani'; letter-spacing: 2px;
            text-transform: uppercase; font-weight: 700;
        }
        select, input {
            width: 100%;
            padding: 14px 16px;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f26 100%);
            border: 1px solid rgba(212, 167, 106, 0.3);
            color: var(--text-main);
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        select:hover {
            border-color: rgba(212, 167, 106, 0.6);
            background: linear-gradient(135deg, #1a1f26 0%, #0f1419 100%);
        }
        select:focus, input:focus {
            border-color: var(--accent-gold);
            outline: none;
            box-shadow: 0 0 0 3px rgba(212, 167, 106, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        select option {
            background: #1a1f26;
            color: var(--text-main);
            padding: 10px;
            font-weight: 500;
        }
        select option:checked {
            background: linear-gradient(90deg, rgba(212, 167, 106, 0.3), rgba(212, 167, 106, 0.1));
            color: var(--accent-gold);
        }
        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 6px; font-weight: bold; font-size: 1.1em; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .btn-outline { background: rgba(102, 252, 241, 0.05); color: var(--text-highlight); border: 1px solid var(--text-highlight); }
        .btn-outline:hover { background: var(--text-highlight); color: #000; }

        .target-display {
            background: linear-gradient(135deg, rgba(212, 167, 106, 0.15), rgba(102, 252, 241, 0.1));
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        .target-display h2 {
            margin: 0 0 10px 0;
            color: var(--accent-gold);
            font-size: 1.8em;
            text-shadow: 0 0 10px var(--accent-glow);
        }
        .target-display .score-needed {
            font-size: 1.3em;
            color: var(--text-highlight);
            font-family: 'Rajdhani', monospace;
        }

        .combo-section {
            margin-top: 25px;
        }
        .combo-header {
            background: #2c241b;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border);
            color: var(--accent-gold);
            font-weight: bold;
            font-size: 1.1em;
        }
        .combo-list {
            background: #0b0c10;
            border: 1px solid #333;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 600px;
            overflow-y: auto;
            /* è‡ªè¨‚æ»¾å‹•æ¢æ¨£å¼ */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: var(--accent-gold) #1a1a1a; /* Firefox: thumb track */
        }
        /* Chrome/Safari/Opera æ»¾å‹•æ¢æ¨£å¼ */
        .combo-list::-webkit-scrollbar {
            width: 8px;
        }
        .combo-list::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 0 0 8px 0;
        }
        .combo-list::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 4px;
            transition: 0.3s;
        }
        .combo-list::-webkit-scrollbar-thumb:hover {
            background: #e5b87a;
            box-shadow: 0 0 6px var(--accent-glow);
        }
        .combo-item {
            padding: 15px 20px;
            border-bottom: 1px solid #222;
            transition: 0.2s;
        }
        .combo-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        .combo-item:last-child {
            border-bottom: none;
        }
        .combo-title {
            color: var(--text-highlight);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        .combo-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .combo-item-line {
            color: #aaa;
            font-family: monospace;
            font-size: 0.9em;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
        }
        .combo-item-line .score {
            color: var(--success);
            font-weight: bold;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #444;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--accent-gold);
        }
        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #333;
            margin-top: 20px;
            /* è‡ªè¨‚æ»¾å‹•æ¢æ¨£å¼ */
            scrollbar-width: thin;
            scrollbar-color: var(--accent-gold) #1a1a1a;
        }
        /* è¡¨æ ¼å®¹å™¨æ»¾å‹•æ¢æ¨£å¼ */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 0 0 8px 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 4px;
            transition: 0.3s;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #e5b87a;
            box-shadow: 0 0 6px var(--accent-glow);
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; font-size: 0.9em; }
        th { background: #2c241b; color: var(--accent-gold); padding: 12px; text-align: left; white-space: nowrap; }
        td { padding: 10px 12px; border-bottom: 1px solid #222; color: #ccc; font-family: monospace; text-align: center; }
        td:first-child { text-align: left; color: #fff; font-weight: bold; }
        tr:hover td { background: rgba(255,255,255,0.05); }

        .filter-section {
            margin-bottom: 25px;
            background: rgba(15, 20, 25, 0.6);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        .filter-title {
            color: var(--accent-gold);
            font-size: 0.95em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            transition: 0.2s;
            cursor: pointer;
        }
        .filter-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .filter-item.unchecked {
            background: rgba(100, 50, 50, 0.15);
            border: 1px solid rgba(150, 70, 70, 0.3);
        }
        .filter-item.unchecked:hover {
            background: rgba(100, 50, 50, 0.25);
        }
        .filter-item.unchecked label {
            color: #888;
            text-decoration: line-through;
        }
        .filter-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-gold);
            pointer-events: auto;
            position: relative;
            z-index: 1;
        }
        .filter-item label {
            margin: 0;
            font-size: 0.9em;
            cursor: pointer;
            text-transform: none;
            letter-spacing: 0;
            font-weight: 400;
            transition: 0.2s;
        }
        .filter-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .filter-btn {
            padding: 8px 16px;
            background: rgba(212, 167, 106, 0.1);
            border: 1px solid rgba(212, 167, 106, 0.3);
            color: var(--accent-gold);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: 0.3s;
        }
        .filter-btn:hover {
            background: rgba(212, 167, 106, 0.2);
            border-color: var(--accent-gold);
        }

        @media (max-width: 700px) {
            .grid-row { flex-direction: column; gap: 10px; }
            .combo-details { grid-template-columns: 1fr; }
            .filter-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>

    <div id="content-wrapper">
        <div class="tech-card">
            <div class="card-title">ç‰©è³ªè®Šæ› (é ­é£¾) è¨ˆç®—æ©Ÿ</div>

            <div class="filter-section">
                <div class="filter-title">ğŸ” ç‰©å“éæ¿¾å™¨</div>

                <div style="margin-bottom: 20px;">
                    <div style="color: #999; font-size: 0.9em; margin-bottom: 10px; font-weight: bold;">è£å‚™éšç´š (æ¬„)</div>
                    <div class="filter-grid" id="tier-filter-grid"></div>
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="color: #999; font-size: 0.9em; margin-bottom: 10px; font-weight: bold;">å¼·åŒ–ç­‰ç´š (åˆ—)</div>
                    <div class="filter-grid" id="grade-filter-grid"></div>
                </div>

                <div class="filter-controls">
                    <button class="filter-btn" onclick="selectAllFilters()">å…¨é¸</button>
                    <button class="filter-btn" onclick="deselectAllFilters()">å…¨ä¸é¸</button>
                </div>
            </div>

            <div class="grid-row">
                <div class="grid-col">
                    <label>é¸æ“‡ç›®æ¨™é ­å†  (TARGET CROWN)</label>
                    <select id="target-crown" onchange="calculateCombos()">
                        <option value="">-- è«‹é¸æ“‡ç›®æ¨™ --</option>
                        <option value="70">ç¬¬2éšï¼šè— T1 (éœ€è¦ 70 åˆ†)</option>
                        <option value="100">ç¬¬3éšï¼šè— T2 (éœ€è¦ 100 åˆ†)</option>
                        <option value="150">ç¬¬4éšï¼šè— T3 (éœ€è¦ 150 åˆ†)</option>
                        <option value="200">ç¬¬5éšï¼šè— T4 (éœ€è¦ 200 åˆ†)</option>
                        <option value="300">ç¬¬6éšï¼šè— T5 (éœ€è¦ 300 åˆ†)</option>
                        <option value="400">ç¬¬7éšï¼šè— T6 (éœ€è¦ 400 åˆ†)</option>
                        <option value="600">ç¬¬8éšï¼šè— T7 (éœ€è¦ 600 åˆ†)</option>
                        <option value="800">ç¬¬9éšï¼šç´« T1 (éœ€è¦ 800 åˆ†)</option>
                        <option value="1100">ç¬¬10éšï¼šç´« T2 (éœ€è¦ 1100 åˆ†)</option>
                        <option value="1700">ç¬¬11éšï¼šç´« T3 (éœ€è¦ 1700 åˆ†)</option>
                        <option value="2700">ç¬¬12éšï¼šç´« T4 (éœ€è¦ 2700 åˆ†)</option>
                        <option value="4400">ç¬¬13éšï¼šç´« T5 (éœ€è¦ 4400 åˆ†)</option>
                    </select>
                </div>
            </div>

            <div id="target-info" style="display:none;">
                <div class="target-display">
                    <h2 id="target-name">-</h2>
                    <div class="score-needed">éœ€è¦ç©åˆ†: <span id="target-score">0</span></div>
                </div>
            </div>

            <div id="result-section" style="display:none;">
                <div class="combo-section">
                    <div class="combo-header" id="combo-header">
                        âœ“ çµ„åˆæ–¹æ¡ˆ
                    </div>
                    <div class="combo-list" id="combo-list">
                        <div class="loading">è¨ˆç®—ä¸­</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tech-card" style="padding:20px;">
            <h3 style="color:#888; font-size:1em; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">DATABASE: è½‰æ›ç©åˆ†è¡¨</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="15%">è£å‚™éšç´š</th>
                            <th>ä¸€èˆ¬å®‰å®š</th><th>ä¸€èˆ¬é2</th><th>ä¸€èˆ¬é3-4</th>
                            <th>ç©¶æ¥µå®‰å®š</th><th>ç©¶æ¥µé2</th><th>ç©¶æ¥µé3-4</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>è— T1</td><td>10</td><td>11</td><td>12</td><td>15</td><td>17</td><td>18</td></tr>
                        <tr><td>è— T2</td><td>30</td><td>33</td><td>36</td><td>45</td><td>50</td><td>54</td></tr>
                        <tr><td>è— T3</td><td>50</td><td>55</td><td>60</td><td>75</td><td>83</td><td>90</td></tr>
                        <tr><td>è— T4</td><td>75</td><td>83</td><td>90</td><td>113</td><td>125</td><td>135</td></tr>
                        <tr><td>è— T5</td><td>100</td><td>110</td><td>165</td><td>150</td><td>165</td><td>248</td></tr>
                        <tr><td>è— T6</td><td>150</td><td>165</td><td>180</td><td>225</td><td>248</td><td>270</td></tr>
                        <tr><td>ç´« T1</td><td>400</td><td>440</td><td>480</td><td>600</td><td>660</td><td>720</td></tr>
                        <tr><td>ç´« T2</td><td>700</td><td>770</td><td>840</td><td>1050</td><td>1155</td><td>1260</td></tr>
                        <tr><td>ç´« T3</td><td>1200</td><td>1320</td><td>1440</td><td>1800</td><td>1980</td><td>2160</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const transData = {
            b1: {name: "è— T1", scores: [10, 11, 12, 15, 17, 18]},
            b2: {name: "è— T2", scores: [30, 33, 36, 45, 50, 54]},
            b3: {name: "è— T3", scores: [50, 55, 60, 75, 83, 90]},
            b4: {name: "è— T4", scores: [75, 83, 90, 113, 125, 135]},
            b5: {name: "è— T5", scores: [100, 110, 165, 150, 165, 248]},
            b6: {name: "è— T6", scores: [150, 165, 180, 225, 248, 270]},
            p1: {name: "ç´« T1", scores: [400, 440, 480, 600, 660, 720]},
            p2: {name: "ç´« T2", scores: [700, 770, 840, 1050, 1155, 1260]},
            p3: {name: "ç´« T3", scores: [1200, 1320, 1440, 1800, 1980, 2160]}
        };

        const gradeNames = ["å®‰å®š(æ™®)", "é2(æ™®)", "é3-4(æ™®)", "å®‰å®š(ç©¶)", "é2(ç©¶)", "é3-4(ç©¶)"];

        // å­˜å„²é¸ä¸­çš„éšç´šå’Œç­‰ç´š
        let selectedTiers = new Set();
        let selectedGrades = new Set();

        const stages = {
            70: "ç¬¬2éšï¼šè— T1",
            100: "ç¬¬3éšï¼šè— T2",
            150: "ç¬¬4éšï¼šè— T3",
            200: "ç¬¬5éšï¼šè— T4",
            300: "ç¬¬6éšï¼šè— T5",
            400: "ç¬¬7éšï¼šè— T6",
            600: "ç¬¬8éšï¼šè— T7",
            800: "ç¬¬9éšï¼šç´« T1",
            1100: "ç¬¬10éšï¼šç´« T2",
            1700: "ç¬¬11éšï¼šç´« T3",
            2700: "ç¬¬12éšï¼šç´« T4",
            4400: "ç¬¬13éšï¼šç´« T5"
        };

        // åˆå§‹åŒ–éæ¿¾å™¨
        function initializeFilters() {
            const tierFilterGrid = document.getElementById('tier-filter-grid');
            const gradeFilterGrid = document.getElementById('grade-filter-grid');

            // ç²å–æ‰€æœ‰éšç´šï¼ˆæ¬„ï¼‰
            const tiers = Object.keys(transData);

            // é»˜èªå…¨é¸
            tiers.forEach(tier => selectedTiers.add(tier));
            gradeNames.forEach((_, idx) => selectedGrades.add(idx));

            // ç”Ÿæˆéšç´šéæ¿¾å™¨
            let tierHtml = '';
            tiers.forEach(tier => {
                const tierName = transData[tier].name;
                tierHtml += `
                    <div class="filter-item" onclick="toggleTierFilter('${tier}')">
                        <input type="checkbox" id="tier_${tier}" checked onclick="event.stopPropagation()" onchange="handleTierFilterChange('${tier}')">
                        <label for="tier_${tier}">${tierName}</label>
                    </div>
                `;
            });
            tierFilterGrid.innerHTML = tierHtml;

            // ç”Ÿæˆç­‰ç´šéæ¿¾å™¨
            let gradeHtml = '';
            gradeNames.forEach((gradeName, idx) => {
                gradeHtml += `
                    <div class="filter-item" onclick="toggleGradeFilter(${idx})">
                        <input type="checkbox" id="grade_${idx}" checked onclick="event.stopPropagation()" onchange="handleGradeFilterChange(${idx})">
                        <label for="grade_${idx}">${gradeName}</label>
                    </div>
                `;
            });
            gradeFilterGrid.innerHTML = gradeHtml;
        }

        // åˆ‡æ›éšç´šéæ¿¾å™¨
        function toggleTierFilter(tier) {
            const checkbox = document.getElementById(`tier_${tier}`);
            checkbox.checked = !checkbox.checked;
            handleTierFilterChange(tier);
        }

        // åˆ‡æ›ç­‰ç´šéæ¿¾å™¨
        function toggleGradeFilter(gradeIdx) {
            const checkbox = document.getElementById(`grade_${gradeIdx}`);
            checkbox.checked = !checkbox.checked;
            handleGradeFilterChange(gradeIdx);
        }

        // è™•ç†éšç´šéæ¿¾å™¨è®ŠåŒ–
        function handleTierFilterChange(tier) {
            const checkbox = document.getElementById(`tier_${tier}`);
            const filterItem = checkbox.closest('.filter-item');

            if (checkbox.checked) {
                selectedTiers.add(tier);
                filterItem.classList.remove('unchecked');
            } else {
                selectedTiers.delete(tier);
                filterItem.classList.add('unchecked');
            }
            recalculateIfNeeded();
        }

        // è™•ç†ç­‰ç´šéæ¿¾å™¨è®ŠåŒ–
        function handleGradeFilterChange(gradeIdx) {
            const checkbox = document.getElementById(`grade_${gradeIdx}`);
            const filterItem = checkbox.closest('.filter-item');

            if (checkbox.checked) {
                selectedGrades.add(gradeIdx);
                filterItem.classList.remove('unchecked');
            } else {
                selectedGrades.delete(gradeIdx);
                filterItem.classList.add('unchecked');
            }
            recalculateIfNeeded();
        }

        // å…¨é¸
        function selectAllFilters() {
            // é¸ä¸­æ‰€æœ‰éšç´š
            Object.keys(transData).forEach(tier => {
                selectedTiers.add(tier);
                const checkbox = document.getElementById(`tier_${tier}`);
                if (checkbox) checkbox.checked = true;
            });

            // é¸ä¸­æ‰€æœ‰ç­‰ç´š
            gradeNames.forEach((_, idx) => {
                selectedGrades.add(idx);
                const checkbox = document.getElementById(`grade_${idx}`);
                if (checkbox) checkbox.checked = true;
            });

            recalculateIfNeeded();
        }

        // å…¨ä¸é¸
        function deselectAllFilters() {
            // å–æ¶ˆæ‰€æœ‰éšç´š
            selectedTiers.clear();
            Object.keys(transData).forEach(tier => {
                const checkbox = document.getElementById(`tier_${tier}`);
                if (checkbox) checkbox.checked = false;
            });

            // å–æ¶ˆæ‰€æœ‰ç­‰ç´š
            selectedGrades.clear();
            gradeNames.forEach((_, idx) => {
                const checkbox = document.getElementById(`grade_${idx}`);
                if (checkbox) checkbox.checked = false;
            });

            recalculateIfNeeded();
        }

        // å¦‚æœéœ€è¦å‰‡é‡æ–°è¨ˆç®—
        function recalculateIfNeeded() {
            if (document.getElementById('target-crown').value) {
                calculateCombos();
            }
        }

        // å»ºç«‹æ‰€æœ‰å¯èƒ½çš„ç‰©å“ï¼ˆè£å‚™+å¼·åŒ–çµ„åˆï¼‰
        function getAllItems() {
            const items = [];
            for (const [key, data] of Object.entries(transData)) {
                data.scores.forEach((score, gradeIdx) => {
                    items.push({
                        key: key,
                        name: data.name,
                        grade: gradeNames[gradeIdx],
                        gradeIdx: gradeIdx,
                        score: score,
                        id: `${key}_${gradeIdx}`
                    });
                });
            }
            // æŒ‰åˆ†æ•¸å¾é«˜åˆ°ä½æ’åº
            return items.sort((a, b) => b.score - a.score);
        }

        // ç²å–å·²é¸ä¸­çš„ç‰©å“ï¼ˆæ ¹æ“šéšç´šå’Œç­‰ç´šéæ¿¾ï¼‰
        function getSelectedItems() {
            return getAllItems().filter(item =>
                selectedTiers.has(item.key) && selectedGrades.has(item.gradeIdx)
            );
        }

        // è¨ˆç®—æ‰€æœ‰å¯èƒ½çš„4ä»¶çµ„åˆ
        function findCombinations(targetScore) {
            const items = getSelectedItems();
            const exactMatches = [];
            const closeMatches = [];

            // å››å±¤è¿´åœˆæ‰¾å‡ºæ‰€æœ‰4ä»¶çµ„åˆ
            for (let i = 0; i < items.length; i++) {
                for (let j = i; j < items.length; j++) {
                    for (let k = j; k < items.length; k++) {
                        for (let l = k; l < items.length; l++) {
                            const total = items[i].score + items[j].score + items[k].score + items[l].score;

                            // å‰›å¥½é”æ¨™çš„çµ„åˆ
                            if (total === targetScore) {
                                exactMatches.push({
                                    items: [items[i], items[j], items[k], items[l]],
                                    total: total,
                                    excess: 0
                                });
                            }
                            // è¶…éç›®æ¨™çš„çµ„åˆï¼ˆä½œç‚ºå‚™é¸ï¼‰
                            else if (total > targetScore && closeMatches.length < 3) {
                                closeMatches.push({
                                    items: [items[i], items[j], items[k], items[l]],
                                    total: total,
                                    excess: total - targetScore
                                });
                            }
                        }
                    }
                }
            }

            // å¦‚æœæœ‰å‰›å¥½é”æ¨™çš„ï¼Œè¿”å›æ‰€æœ‰å‰›å¥½é”æ¨™çš„çµ„åˆï¼ˆåè½‰é †åºï¼‰
            if (exactMatches.length > 0) {
                return exactMatches.reverse();
            }

            // å¦‚æœæ²’æœ‰å‰›å¥½é”æ¨™çš„ï¼Œè¿”å›æœ€æ¥è¿‘çš„å‰3å€‹
            return closeMatches.sort((a, b) => a.excess - b.excess).slice(0, 3);
        }

        function calculateCombos() {
            const targetSelect = document.getElementById('target-crown');
            const targetScore = parseInt(targetSelect.value);

            if (!targetScore) {
                document.getElementById('target-info').style.display = 'none';
                document.getElementById('result-section').style.display = 'none';
                return;
            }

            // é¡¯ç¤ºç›®æ¨™è³‡è¨Š
            document.getElementById('target-name').textContent = stages[targetScore];
            document.getElementById('target-score').textContent = targetScore;
            document.getElementById('target-info').style.display = 'block';
            document.getElementById('result-section').style.display = 'block';

            const comboList = document.getElementById('combo-list');
            comboList.innerHTML = '<div class="loading">è¨ˆç®—ä¸­</div>';

            // å»¶é²åŸ·è¡Œï¼Œè®“UIæœ‰æ™‚é–“æ›´æ–°
            setTimeout(() => {
                const combos = findCombinations(targetScore);

                if (combos.length === 0) {
                    comboList.innerHTML = '<div class="no-data">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„çµ„åˆ</div>';
                    document.getElementById('combo-header').innerHTML = 'âœ“ çµ„åˆæ–¹æ¡ˆ';
                } else {
                    const isExactMatch = combos[0].excess === 0;

                    // æ›´æ–°æ¨™é¡Œ
                    if (isExactMatch) {
                        document.getElementById('combo-header').innerHTML = `âœ“ å‰›å¥½é”æ¨™æ–¹æ¡ˆ (å…± ${combos.length} ç¨®)`;
                    } else {
                        document.getElementById('combo-header').innerHTML = `âœ“ æœ€æ¥è¿‘æ–¹æ¡ˆ (ç„¡å‰›å¥½é”æ¨™ï¼Œé¡¯ç¤ºå‰ ${combos.length} ç¨®)`;
                    }

                    let html = '';
                    combos.forEach((combo, idx) => {
                        let title = '';
                        if (isExactMatch) {
                            title = `æ–¹æ¡ˆ ${idx + 1}`;
                        } else {
                            const labels = ['ğŸ¥‡ æœ€æ¥è¿‘æ–¹æ¡ˆ', 'ğŸ¥ˆ æ¬¡æ¥è¿‘æ–¹æ¡ˆ', 'ğŸ¥‰ ç¬¬ä¸‰æ–¹æ¡ˆ'];
                            title = labels[idx] || `æ–¹æ¡ˆ ${idx + 1}`;
                        }

                        html += `
                            <div class="combo-item">
                                <div class="combo-title">
                                    ${title} - ç¸½åˆ†: ${combo.total}
                                    ${combo.excess > 0 ? `(è¶…å‡º ${combo.excess} åˆ†)` : '(âœ“ å‰›å¥½é”æ¨™)'}
                                </div>
                                <div class="combo-details">
                                    ${combo.items.map((item, i) => `
                                        <div class="combo-item-line">
                                            [${i+1}] ${item.name} - ${item.grade}
                                            <span class="score">+${item.score}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });

                    comboList.innerHTML = html;
                }

                notifyParentResize();
            }, 100);
        }

        // é€šçŸ¥çˆ¶é é¢èª¿æ•´é«˜åº¦
        function notifyParentResize() {
            const height = document.documentElement.scrollHeight;
            if(window.parent !== window) {
                window.parent.postMessage({type: 'resize', height: height}, '*');
            }
        }

        // ç›£è½å…§å®¹è®ŠåŒ–
        window.addEventListener('load', () => {
            initializeFilters();
            notifyParentResize();
        });
        const observer = new MutationObserver(notifyParentResize);
        observer.observe(document.body, { attributes: true, childList: true, subtree: true });

        // è®“è¡¨æ ¼å®¹å™¨æ”¯æ´æ»¾è¼ªæ©«å‘æ»‘å‹•
        document.addEventListener('DOMContentLoaded', function() {
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.addEventListener('wheel', function(e) {
                    // å¦‚æœæœ‰æ©«å‘æ»¾å‹•ç©ºé–“ï¼Œæ””æˆªå‚ç›´æ»¾è¼ªäº‹ä»¶ä¸¦è½‰ç‚ºæ©«å‘æ»¾å‹•
                    if (this.scrollWidth > this.clientWidth) {
                        e.preventDefault();
                        this.scrollLeft += e.deltaY;
                    }
                }, { passive: false });
            }
        });
    </script>
</body>
</html>
