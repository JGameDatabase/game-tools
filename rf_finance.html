<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RF è³‡ç”¢å¸³ç°¿</title>
    <style>
        :root {
            /* === ç¥ç€é»‘é…è‰² === */
            --bg: #1a1817; --panel: #262322; --border: #3d3633;
            --text: #e6dfd6; --text-dim: #8c8580;
            --gold: #dcb36c; --green: #8fb35d; --red: #d66e6e;
            --blue: #6ca0dc; --purple: #b589d6; --cyan: #6cdccf; --orange: #dc966c;
            --convert: #d4a76a; 
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        *::-webkit-scrollbar { width: 6px; height: 6px; }
        *::-webkit-scrollbar-track { background: var(--bg); }
        *::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        *::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px 20px 80px; letter-spacing: 0.5px;
            overflow-y: auto; /* ä¿®æ­£æ»¾å‹•æ¢å±¬æ€§ */
        }

        .container { max-width: 1100px; margin: 0 auto; }
        
        /* é–å®šç•«é¢ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: var(--panel); padding: 40px; border-radius: 12px;
            border: 1px solid var(--border); text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .login-input {
            background: #111 !important; border: 1px solid var(--border) !important; color: var(--gold) !important;
            padding: 10px; font-size: 1.2em; text-align: center; letter-spacing: 5px;
            width: 200px; border-radius: 6px; margin-bottom: 20px; font-family: monospace;
        }
        .login-btn {
            background: var(--gold); color: #000; border: none; padding: 10px 30px; font-weight: bold; cursor: pointer; border-radius: 4px;
        }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .header h1 { margin: 0; font-size: 1.4em; color: var(--gold); letter-spacing: 1px; }
        .tools button { background: none; border: 1px solid var(--border); color: var(--text-dim); font-size: 0.8em; cursor: pointer; margin-left: 10px; padding: 5px 10px; border-radius: 4px; transition: 0.2s; }
        .tools button:hover { border-color: var(--text); color: var(--text); }

        /* === çµ±è¨ˆé€±æœŸåˆ‡æ›å™¨ (å„ªå…ˆæ¬Šä¿®å¾©) === */
        .filter-bar { 
            display: flex; justify-content: center; margin-bottom: 25px; gap: 10px; 
            position: relative; z-index: 10; /* å¼·åˆ¶ç½®é ‚ */
        }
        .filter-btn {
            background: var(--panel); border: 1px solid var(--border); color: var(--text-dim);
            padding: 8px 25px; border-radius: 20px; cursor: pointer; 
            font-size: 0.95em; font-weight: bold; transition: 0.2s;
            user-select: none; /* é˜²æ­¢é€£é»åç™½ */
        }
        .filter-btn:hover { background: #333; color: var(--text); border-color: #666; }
        .filter-btn.active { 
            background: var(--gold); color: #000; border-color: var(--gold); 
            box-shadow: 0 0 15px rgba(220, 179, 108, 0.4); 
        }

        /* Scoreboard */
        .scoreboard { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px; }
        .score-item { text-align: center; background: rgba(255,255,255,0.02); padding: 15px 5px; border-radius: 8px; border: 1px solid transparent; }
        .score-label { font-size: 0.8em; color: var(--text-dim); margin-bottom: 5px; }
        .score-num { font-size: 1.4em; font-weight: 700; font-family: 'Consolas', monospace; }
        .c-gold { color: var(--gold); } .c-green { color: var(--green); } .c-red { color: var(--red); } .c-purple { color: var(--purple); } .c-cyan { color: var(--cyan); }
        @media (max-width: 900px) { .scoreboard { grid-template-columns: 1fr 1fr; } }

        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 40px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
        .panel-header { margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        h2 { margin: 0; font-size: 1em; font-weight: 500; color: var(--text-dim); }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { text-align: left; color: var(--text-dim); padding: 8px 4px; border-bottom: 1px solid var(--border); font-weight: normal; }
        td { padding: 10px 4px; border-bottom: 1px solid #2a2624; color: var(--text); }
        .mono-num { font-family: 'Consolas', monospace; }
        .break-even { color: var(--gold); background: rgba(220, 179, 108, 0.1); padding: 2px 6px; border-radius: 4px; }

        /* Tabs */
        .tab-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 20px; }
        .tab { padding: 6px 12px; cursor: pointer; font-size: 0.85em; color: var(--text-dim); border-radius: 4px; background: rgba(255,255,255,0.05); transition: 0.2s; text-align: center; flex: 1; min-width: 60px;}
        .tab:hover { color: var(--text); background: rgba(255,255,255,0.1); }
        .tab.active { color: #000; font-weight: bold; }
        /* Tab Colors */
        .tab.active[data-val="buy"] { background: var(--blue); }
        .tab.active[data-val="sell_trade"] { background: var(--green); }
        .tab.active[data-val="sell_loot"] { background: var(--purple); color: #fff; }
        .tab.active[data-val="craft"] { background: var(--orange); }
        .tab.active[data-val="convert"] { background: var(--convert); }
        .tab.active[data-val="use"] { background: var(--red); color: #fff; }
        .tab.active[data-val="cash_out"] { background: var(--cyan); }

        /* Input */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.8em; color: var(--text-dim); }
        
        input { 
            width: 100%; padding: 10px; box-sizing: border-box;
            background-color: #111 !important; border: 1px solid var(--border); 
            color: var(--text) !important; font-family: 'Consolas', monospace; font-size: 1.1em;
            border-radius: 4px; transition: 0.2s;
        }
        input:focus { outline: none; border-color: var(--gold); background-color: #000 !important; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .smart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        #btnSubmit { 
            width: 100%; padding: 12px; margin-top: 10px; 
            background: var(--gold); color: #1a1817; border: none; 
            font-weight: 600; font-size: 1em; border-radius: 4px; cursor: pointer;
        }
        #btnSubmit:hover { filter: brightness(1.1); }
        
        .btn-import-batch {
            width: 100%; padding: 10px; margin-top: 10px;
            background: rgba(108, 160, 220, 0.1); border: 1px dashed var(--blue); color: var(--blue);
            font-size: 0.9em; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .btn-import-batch:hover { background: rgba(108, 160, 220, 0.2); }

        .section-box { display: none; }

        /* Ledger */
        .log-row { display: grid; grid-template-columns: 1fr 0.8fr 2fr 1fr 0.5fr; padding: 10px 5px; border-bottom: 1px solid #2a2624; align-items: center; font-size: 0.9em; color: var(--text-dim); }
        .log-row:hover { color: var(--text); background: rgba(255,255,255,0.02); }
        .tag-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }
        .dot-buy { background: var(--blue); } .dot-sell { background: var(--green); }
        .dot-loot { background: var(--purple); } .dot-use { background: var(--red); }
        .dot-craft { background: var(--orange); } .dot-cash { background: var(--cyan); }
        .dot-convert { background: var(--convert); }

        .action-cell { display: flex; justify-content: center; gap: 8px; }
        .btn-icon { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 1em; padding: 0; }
        .btn-icon:hover { color: var(--text); }
        .btn-convert { color: var(--convert); }
        .btn-del:hover { color: var(--red); }

        #importFile { display: none; }

        /* === æ‰¹é‡åŒ¯å…¥è¦–çª— === */
        #importModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--panel); border: 1px solid var(--border); padding: 25px;
            border-radius: 8px; width: 500px; max-width: 90%;
        }
        .close-btn { float: right; cursor: pointer; color: #fff; font-size: 1.2em; }
        textarea { width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; color: #fff; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.9em; margin-top: 10px; }
        textarea:focus { outline: none; border-color: var(--blue); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <div class="login-title">ACCESS LOCKED</div>
        <input type="password" id="passInput" class="login-input" placeholder="PASSCODE" onkeyup="checkEnter(event)">
        <br><button class="login-btn" onclick="checkPass()">UNLOCK</button>
    </div>
</div>

<div id="importModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeImport()">Ã—</span>
        <h2 style="color:var(--blue); margin:0;">ğŸ“¥ æ‰¹é‡åŒ¯å…¥äº¤æ˜“</h2>
        <p style="color:#aaa; font-size:0.9em;">è«‹è²¼ä¸Š AI æ•´ç†å¥½çš„ JSON ä»£ç¢¼ï¼š</p>
        <textarea id="importArea" rows="10" placeholder='[{"type":"buy", "item":"5è¬Cå¹£å¡", "price":2.4, "qty":92}, ...]'></textarea>
        <button class="login-btn" style="width:100%; margin-top:15px; background:var(--blue);" onclick="processImport()">ç¢ºèªåŒ¯å…¥</button>
    </div>
</div>

<div class="container">
    <div class="header">
        <h1>RF è³‡ç”¢å¸³ç°¿ <span>v4.9</span></h1>
        <div class="tools">
            <button onclick="exportData()">å‚™ä»½</button>
            <button onclick="document.getElementById('importFile').click()">é‚„åŸ</button>
            <button onclick="clearData()" style="color:var(--red); border-color:var(--red);">é‡ç½®</button>
            <input type="file" id="importFile" accept=".json" onchange="importData(this)">
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-btn" onclick="setPeriod(1)" id="btnP1">ä»Šæ—¥</div>
        <div class="filter-btn" onclick="setPeriod(7)" id="btnP7">7å¤©</div>
        <div class="filter-btn" onclick="setPeriod(30)" id="btnP30">30å¤©</div>
        <div class="filter-btn active" onclick="setPeriod(0)" id="btnP0">å…¨éƒ¨</div>
    </div>

    <div class="scoreboard">
        <div class="score-item"><div class="score-label">ç´¯è¨ˆå¥—ç¾ (TWD)</div><div class="score-num c-cyan" id="dispRealMoney">0</div></div>
        <div class="score-item"><div class="score-label">éŠæˆ²å…§ç¾é‡‘æµ</div><div class="score-num" id="dispCashFlow">0</div></div>
        <div class="score-item"><div class="score-label">æ“ç›¤ç²åˆ©</div><div class="score-num c-green" id="dispTradeProfit">0</div></div>
        <div class="score-item"><div class="score-label">æ‰“å¯¶æ”¶å…¥</div><div class="score-num c-purple" id="dispLootIncome">0</div></div>
        <div class="score-item"><div class="score-label">æ©Ÿé«”æ¶ˆè²»</div><div class="score-num c-red" id="dispExpense">0</div></div>
    </div>

    <div class="main-grid">
        <div class="panel">
            <div class="panel-header"><h2>åº«å­˜ç›£æ§ (ç›®å‰æŒå€‰)</h2></div>
            <table id="inventoryTable">
                <thead><tr><th>ç‰©å“</th><th>æŒæœ‰</th><th>å‡åƒ¹</th><th style="color:var(--gold)">âš¡ä¿æœ¬(å«ç¨…)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="panel">
            <div class="panel-header"><h2>äº¤æ˜“æ“ä½œ</h2></div>
            
            <div class="tab-container">
                <div class="tab active" data-val="buy" onclick="setType('buy')">è²·å…¥</div>
                <div class="tab" data-val="sell_trade" onclick="setType('sell_trade')">è³£è²¨</div>
                <div class="tab" data-val="sell_loot" onclick="setType('sell_loot')">è³£å¯¶</div>
                <div class="tab" data-val="craft" onclick="setType('craft')">åˆæˆ</div>
                <div class="tab" data-val="convert" onclick="setType('convert')">è½‰è‡ªç”¨</div>
                <div class="tab" data-val="use" onclick="setType('use')">è‡ªç”¨</div>
                <div class="tab" data-val="cash_out" onclick="setType('cash_out')">å¥—ç¾</div>
            </div>

            <div id="normalSection" class="section-box" style="display:block;">
                <div class="input-group">
                    <label>ç‰©å“åç¨±</label>
                    <input list="itemSuggestions" id="inItem" placeholder="æœå°‹æˆ–è¼¸å…¥...">
                    <datalist id="itemSuggestions"><option value="5è¬Cå¹£å¡"><option value="50è¬Cå¹£å¡"><option value="éµç¤¦"><option value="å¼·åŒ–çŸ³"></datalist>
                </div>
                <div class="smart-row">
                    <div class="input-group"><label>æ•¸é‡</label><input type="number" id="inQty" placeholder="0" oninput="autoCalc('qty')"></div>
                    <div class="input-group"><label id="lblPrice">å–®åƒ¹</label><input type="number" id="inPrice" step="0.001" placeholder="0.00" oninput="autoCalc('price')"></div>
                </div>
                <div class="input-group"><label>ç¸½é‡‘é¡</label><input type="number" id="inTotal" step="0.1" placeholder="0.00" oninput="autoCalc('total')" style="color:var(--gold)"></div>
            </div>

            <div id="convertSection" class="section-box" style="background: rgba(212, 167, 106, 0.05); padding: 15px; border-radius: 8px; border: 1px dashed var(--convert);">
                <div style="color:var(--convert); font-weight:bold; margin-bottom:10px; text-align:center; font-size:0.9em;">ğŸ”„ åº«å­˜è½‰è‡ªç”¨</div>
                <div class="input-group"><label>ç‰©å“åç¨±</label><input list="itemSuggestions" id="cvItem" placeholder="é¸æ“‡åº«å­˜ç‰©å“..."></div>
                <div class="input-group"><label>è½‰æ›æ•¸é‡</label><input type="number" id="cvQty" placeholder="0"></div>
            </div>

            <div id="craftSection" class="section-box">
                <div class="smart-row"><div class="input-group"><label>åŸæ–™</label><input list="itemSuggestions" id="srcItem" placeholder="ä¾†æº"></div><div class="input-group"><label>æ•¸é‡</label><input type="number" id="srcQty" placeholder="0"></div></div>
                <div style="text-align:center; color:var(--text-dim); margin-bottom:10px;">â†“ åŠ å·¥ â†“</div>
                <div class="smart-row"><div class="input-group"><label>æˆå“</label><input list="itemSuggestions" id="tgtItem" placeholder="ç›®æ¨™"></div><div class="input-group"><label>æ•¸é‡</label><input type="number" id="tgtQty" placeholder="0"></div></div>
                <div class="input-group"><label>æ‰‹çºŒè²»</label><input type="number" id="craftFee" placeholder="0" value="0"></div>
            </div>

            <div id="cashOutSection" class="section-box">
                <div class="input-group"><label>è³£å‡ºé‘½çŸ³é‡</label><input type="number" id="cashQty" placeholder="0" oninput="autoCalcCash('qty')"></div>
                <div class="smart-row">
                    <div class="input-group"><label style="color:var(--gold)">ç²å¾—å°å¹£</label><input type="number" id="cashTotal" placeholder="0" oninput="autoCalcCash('total')"></div>
                    <div class="input-group"><label>åŒ¯ç‡(å¹¾é‘½æ›1å…ƒ)</label><input type="number" id="cashRatio" step="0.001" placeholder="0" oninput="autoCalcCash('ratio')"></div>
                </div>
            </div>
            
            <button id="btnSubmit" onclick="submitTrade()">åŸ·è¡Œ</button>
            <button class="btn-import-batch" onclick="openImport()">ğŸ“¥ æ‰¹é‡åŒ¯å…¥äº¤æ˜“ (From AI)</button>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>äº¤æ˜“ç´€éŒ„ <span id="logTitle" style="font-size:0.8em; color:var(--gold); margin-left:10px;">(å…¨éƒ¨)</span></h2>
        </div>
        <div id="ledgerList"></div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="loadMore()" id="btnLoadMore" style="background:none; border:none; color:var(--text-dim); font-size:0.9em; display:none;">â–¼ è¼‰å…¥æ›´å¤š</button>
        </div>
    </div>
</div>

<script>
    const PASSWORD = "5490";
    function checkPass() { if(document.getElementById('passInput').value === PASSWORD) { document.getElementById('loginOverlay').style.display = 'none'; } else { alert("å¯†ç¢¼éŒ¯èª¤"); document.getElementById('passInput').value = ""; document.getElementById('passInput').focus(); } }
    function checkEnter(e) { if(e.key === "Enter") checkPass(); }
    window.onload = function() { document.getElementById('passInput').focus(); renderAll(); }

    const TAX_RATE = 0.08; 
    let trades = JSON.parse(localStorage.getItem('rf_trade_data')) || [];
    let currentType = 'buy'; 
    let displayLimit = 20;
    let currentInventoryState = {}; 
    let filterDays = 0; // 0=å…¨éƒ¨, 1=ä»Šæ—¥, 7=7å¤©...

    const typeConfig = {
        'buy':        { label: 'ç¢ºèªè²·å…¥', needPrice: true, priceLabel: 'å–®åƒ¹ (æˆæœ¬)' },
        'use':        { label: 'ç¢ºèªæ¶ˆè²»', needPrice: true, priceLabel: 'å–®åƒ¹ (æˆæœ¬)' },
        'sell_trade': { label: 'ç¢ºèªè³£å‡º', needPrice: true, priceLabel: 'å¯¦æ”¶å–®åƒ¹' },
        'sell_loot':  { label: 'ç¢ºèªè³£å‡º', needPrice: true, priceLabel: 'å¯¦æ”¶å–®åƒ¹' },
        'craft':      { label: 'åŸ·è¡Œåˆæˆ', needPrice: false },
        'convert':    { label: 'åŸ·è¡Œè½‰ç§»', needPrice: false },
        'cash_out':   { label: 'ç¢ºèªå¥—ç¾', needPrice: false }
    };

    updateInputState();

    function openImport() { document.getElementById('importModal').style.display = 'flex'; }
    function closeImport() { document.getElementById('importModal').style.display = 'none'; }

    // === æ—¥æœŸè§£æå°å¹«æ‰‹ (è§£æ±ºç›¸å®¹æ€§å•é¡Œ) ===
    function parseSafeDate(dateStr) {
        if(!dateStr) return new Date();
        const safe = dateStr.replace(/[\.-]/g, '/'); // æ›¿æ›åˆ†éš”ç¬¦
        const d = new Date(safe);
        if(isNaN(d.getTime())) return new Date();
        return d;
    }

    // === æ ¸å¿ƒé‚è¼¯ï¼šæ™ºæ…§åº«å­˜åˆ¤æ–·åŒ¯å…¥ ===
    function processImport() {
        const raw = document.getElementById('importArea').value;
        try {
            const data = JSON.parse(raw);
            if(!Array.isArray(data)) throw new Error("æ ¼å¼éŒ¯èª¤ï¼Œå¿…é ˆæ˜¯ Array");
            
            // 1. å–å¾—ç¾æœ‰åº«å­˜
            const statsBefore = calculateStats().inventory;
            let tempInv = JSON.parse(JSON.stringify(statsBefore));
            let count = 0;

            // 2. è™•ç†åŒ¯å…¥
            data.forEach(item => {
                if(item.item && item.type) {
                    let finalType = item.type;
                    const itemQty = parseInt(item.qty) || 1;

                    if (item.type.includes('sell')) {
                        const currentStock = tempInv[item.item] ? tempInv[item.item].qty : 0;
                        if (currentStock >= itemQty) {
                            finalType = 'sell_trade';
                            tempInv[item.item].qty -= itemQty;
                        } else {
                            finalType = 'sell_loot';
                        }
                    } else if (item.type === 'buy') {
                         if(!tempInv[item.item]) tempInv[item.item] = {qty: 0};
                         tempInv[item.item].qty += itemQty;
                    }

                    const tradeDate = parseSafeDate(item.date);

                    const trade = {
                        id: Date.now() + Math.floor(Math.random() * 100000) + count,
                        date: tradeDate.toISOString(),
                        type: finalType,
                        item: item.item,
                        price: parseFloat(item.price) || 0,
                        qty: itemQty
                    };
                    trades.unshift(trade);
                    count++;
                }
            });

            // 3. è‡ªå‹•æ’åº (ç¢ºä¿æœ€æ–°äº¤æ˜“åœ¨æœ€ä¸Šé¢)
            trades.sort((a, b) => new Date(b.date) - new Date(a.date));

            saveData();
            setPeriod(0); // è‡ªå‹•åˆ‡å› "å…¨éƒ¨" ç¢ºä¿çœ‹å¾—åˆ°è³‡æ–™
            
            alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†äº¤æ˜“ï¼`);
            closeImport();
            document.getElementById('importArea').value = '';
        } catch(e) { alert("JSON éŒ¯èª¤ï¼š" + e.message); }
    }

    function setPeriod(days) {
        filterDays = days;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btnP${days}`).classList.add('active');
        const titles = {0: '(å…¨éƒ¨)', 1: '(ä»Šæ—¥)', 7: '(è¿‘7å¤©)', 30: '(è¿‘30å¤©)'};
        document.getElementById('logTitle').innerText = titles[days];
        renderAll();
    }

    // === æ—¥æœŸéæ¿¾é‚è¼¯ ===
    function isWithinPeriod(dateStr) {
        if (filterDays === 0) return true;
        const tradeDate = new Date(dateStr);
        const now = new Date();
        
        if (filterDays === 1) {
            return tradeDate.toDateString() === now.toDateString();
        }
        
        const past = new Date();
        past.setDate(now.getDate() - filterDays);
        past.setHours(0, 0, 0, 0);
        
        return tradeDate >= past;
    }

    function setType(type) {
        currentType = type;
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelector(`.tab[data-val="${type}"]`).classList.add('active');
        updateInputState();
    }

    function updateInputState() {
        const config = typeConfig[currentType];
        const btn = document.getElementById('btnSubmit');
        const sections = ['normalSection', 'craftSection', 'convertSection', 'cashOutSection'];
        const lblPrice = document.getElementById('lblPrice');

        btn.innerText = config.label;
        btn.style.background = `var(--${getThemeColor(currentType)})`;
        btn.style.color = (['buy', 'sell_trade', 'sell_loot', 'cash_out'].includes(currentType)) ? '#000' : '#fff'; 
        if(currentType === 'buy' || currentType === 'sell_trade' || currentType === 'cash_out' || currentType === 'convert') btn.style.color = '#000';

        if(config.priceLabel && lblPrice) lblPrice.innerText = config.priceLabel;

        sections.forEach(id => document.getElementById(id).style.display = 'none');

        if (currentType === 'craft') document.getElementById('craftSection').style.display = 'block';
        else if (currentType === 'convert') document.getElementById('convertSection').style.display = 'block';
        else if (currentType === 'cash_out') document.getElementById('cashOutSection').style.display = 'block';
        else {
            document.getElementById('normalSection').style.display = 'block';
            const priceInput = document.getElementById('inPrice');
            const totalInput = document.getElementById('inTotal');
            if (!config.needPrice) {
                 priceInput.value = 0; priceInput.disabled = true;
                 totalInput.value = 0; totalInput.disabled = true;
            } else {
                 priceInput.disabled = false;
                 totalInput.disabled = false;
            }
        }
    }

    function getThemeColor(type) {
        if(type.includes('buy')) return 'blue';
        if(type.includes('sell_trade')) return 'green';
        if(type.includes('sell_loot')) return 'purple';
        if(type === 'use') return 'red';
        if(type === 'craft') return 'orange';
        if(type === 'convert') return 'convert';
        if(type === 'cash_out') return 'cyan';
        return 'gold';
    }

    function autoCalc(source) {
        const elQty = document.getElementById('inQty');
        const elTotal = document.getElementById('inTotal');
        const elPrice = document.getElementById('inPrice');
        let qty = parseFloat(elQty.value);
        let total = parseFloat(elTotal.value);
        let price = parseFloat(elPrice.value);
        if (!qty) return;
        if (source === 'total' && total) elPrice.value = (total / qty).toFixed(4);
        else if (source === 'price' && price) elTotal.value = (price * qty).toFixed(2);
        else if (source === 'qty' && price) elTotal.value = (price * qty).toFixed(2);
    }

    function autoCalcCash(source) {
        const elQty = document.getElementById('cashQty');    
        const elTotal = document.getElementById('cashTotal'); 
        const elRatio = document.getElementById('cashRatio'); 
        let qty = parseFloat(elQty.value);
        let total = parseFloat(elTotal.value);
        let ratio = parseFloat(elRatio.value);
        if (source === 'total' && total && qty) elRatio.value = (qty / total).toFixed(4);
        else if (source === 'ratio' && ratio && qty) elTotal.value = (qty / ratio).toFixed(0);
        else if (source === 'qty' && ratio) elTotal.value = (qty / ratio).toFixed(0);
    }

    function submitTrade() {
        if (currentType === 'craft') { submitCraft(); return; }
        if (currentType === 'convert') { submitConvert(); return; }
        if (currentType === 'cash_out') { submitCashOut(); return; }

        const item = document.getElementById('inItem').value.trim();
        let price = parseFloat(document.getElementById('inPrice').value);
        const qty = parseInt(document.getElementById('inQty').value);

        if (!item || isNaN(qty)) { alert("è«‹å¡«å¯«å®Œæ•´ï¼"); return; }
        if (isNaN(price)) price = 0;

        const trade = {
            id: Date.now(),
            date: new Date().toISOString(),
            type: currentType,
            item: item, price: price, qty: qty
        };
        pushTrade(trade);
        document.getElementById('inQty').value = '';
        document.getElementById('inTotal').value = '';
    }

    function submitCraft() {
        const srcItem = document.getElementById('srcItem').value.trim();
        const srcQty = parseInt(document.getElementById('srcQty').value);
        const tgtItem = document.getElementById('tgtItem').value.trim();
        const tgtQty = parseInt(document.getElementById('tgtQty').value);
        const fee = parseFloat(document.getElementById('craftFee').value) || 0;
        if (!srcItem || !tgtItem) { alert("è«‹å¡«å¯«å®Œæ•´ï¼"); return; }
        const trade = {
            id: Date.now(), date: new Date().toISOString(), type: 'craft',
            item: srcItem, qty: srcQty, tgtItem: tgtItem, tgtQty: tgtQty, fee: fee
        };
        pushTrade(trade);
        document.getElementById('srcQty').value = '';
        document.getElementById('tgtQty').value = '';
    }

    function submitConvert() {
        const item = document.getElementById('cvItem').value.trim();
        const qty = parseInt(document.getElementById('cvQty').value);
        if (!item || !qty) { alert("è«‹è¼¸å…¥ç‰©å“å’Œæ•¸é‡"); return; }
        const currentInv = currentInventoryState[item];
        if (!currentInv || currentInv.qty < qty) { alert(`åº«å­˜ä¸è¶³ï¼ç›®å‰ ${item} åªæœ‰ ${currentInv ? currentInv.qty : 0} å€‹`); return; }
        const trade = {
            id: Date.now(), date: new Date().toISOString(), type: 'convert', item: item, qty: qty
        };
        pushTrade(trade);
        document.getElementById('cvQty').value = '';
    }

    function submitCashOut() {
        const qty = parseFloat(document.getElementById('cashQty').value);
        const total = parseFloat(document.getElementById('cashTotal').value);
        const ratio = parseFloat(document.getElementById('cashRatio').value);
        if (!qty || !total) { alert("è«‹å¡«å¯«å®Œæ•´ï¼"); return; }
        const trade = {
            id: Date.now(), date: new Date().toISOString(), type: 'cash_out',
            item: 'é‘½çŸ³', qty: qty, total: total, ratio: ratio
        };
        pushTrade(trade);
        document.getElementById('cashQty').value = '';
        document.getElementById('cashTotal').value = '';
    }

    function pushTrade(trade) {
        trades.unshift(trade);
        trades.sort((a, b) => new Date(b.date) - new Date(a.date));
        saveData();
        displayLimit = 20;
        renderAll();
    }

    function toggleType(id) {
        const trade = trades.find(t => t.id === id);
        if (!trade) return;
        if (trade.type === 'buy') {
            if(confirm(`è½‰ç‚ºã€Œè‡ªç”¨ã€ï¼Ÿ`)) { trade.type = 'use'; saveData(); renderAll(); }
        } else if (trade.type === 'use') {
            if(confirm(`è½‰ç‚ºã€Œè²·å…¥ã€ï¼Ÿ`)) { trade.type = 'buy'; saveData(); renderAll(); }
        }
    }

    function calculateStats() {
        let inventory = {}; 
        let stats = { cashFlow: 0, tradeProfit: 0, lootIncome: 0, expense: 0, realCash: 0 };
        
        let allTradesAsc = trades.slice().reverse();
        
        allTradesAsc.forEach(t => {
            if (!inventory[t.item]) inventory[t.item] = { qty: 0, cost: 0 };
            if (t.type === 'craft' && t.tgtItem && !inventory[t.tgtItem]) inventory[t.tgtItem] = { qty: 0, cost: 0 };

            const inv = inventory[t.item];
            const total = (t.price || 0) * (t.qty || 0);
            const inTime = isWithinPeriod(t.date); 

            switch(t.type) {
                case 'buy': 
                    if(inTime) stats.cashFlow -= total;
                    inv.qty += t.qty; inv.cost += total; 
                    break;
                case 'sell_trade': 
                    const rev1 = total; 
                    if(inTime) stats.cashFlow += rev1;
                    
                    let avg1 = inv.qty > 0 ? inv.cost / inv.qty : 0;
                    const cogs1 = avg1 * t.qty;
                    
                    if(inTime) stats.tradeProfit += (rev1 - cogs1);
                    inv.qty -= t.qty; inv.cost -= cogs1; 
                    break;
                case 'sell_loot': 
                    const rev2 = total; 
                    if(inTime) { stats.cashFlow += rev2; stats.lootIncome += rev2; }
                    break;
                case 'use': 
                    if(inTime) { stats.cashFlow -= total; stats.expense += total; }
                    break;
                case 'craft':
                    let avgSrc = inv.qty > 0 ? inv.cost / inv.qty : 0;
                    const matCost = avgSrc * t.qty;
                    inv.qty -= t.qty; inv.cost -= matCost;
                    const tgtInv = inventory[t.tgtItem];
                    tgtInv.qty += t.tgtQty; tgtInv.cost += (matCost + t.fee);
                    
                    if(inTime) stats.cashFlow -= t.fee; 
                    break;
                case 'convert':
                    let avgConv = inv.qty > 0 ? inv.cost / inv.qty : 0;
                    const convCost = avgConv * t.qty;
                    inv.qty -= t.qty; inv.cost -= convCost;
                    if(inTime) stats.expense += convCost;
                    break;
                case 'cash_out':
                    if(inTime) { stats.cashFlow -= t.qty; stats.realCash += t.total; }
                    break;
            }
        });
        
        currentInventoryState = JSON.parse(JSON.stringify(inventory));
        return { stats, inventory };
    }

    function renderAll() {
        const { stats, inventory } = calculateStats();
        const fmt = (n) => n.toLocaleString(undefined, { maximumFractionDigits: 0 });
        
        document.getElementById('dispRealMoney').innerText = "+" + fmt(stats.realCash);
        document.getElementById('dispCashFlow').innerText = fmt(stats.cashFlow);
        document.getElementById('dispCashFlow').style.color = stats.cashFlow >= 0 ? 'var(--text)' : 'var(--text)';
        document.getElementById('dispTradeProfit').innerText = (stats.tradeProfit > 0 ? "+" : "") + fmt(stats.tradeProfit);
        document.getElementById('dispLootIncome').innerText = "+" + fmt(stats.lootIncome);
        document.getElementById('dispExpense').innerText = "-" + fmt(stats.expense);

        const invBody = document.querySelector('#inventoryTable tbody');
        invBody.innerHTML = '';
        let hasInv = false;
        for (const [name, data] of Object.entries(inventory)) {
            if (data.qty > 0.01) {
                hasInv = true;
                const avg = data.cost / data.qty;
                const breakEven = avg / (1 - TAX_RATE);
                invBody.innerHTML += `
                    <tr>
                        <td style="color:var(--text); font-weight:500;">${name}</td>
                        <td class="mono-num" style="color:var(--text); font-weight:bold;">${parseFloat(data.qty.toFixed(2))}</td>
                        <td class="mono-num" style="color:var(--text-dim);">${avg.toFixed(3)}</td>
                        <td class="mono-num break-even">${breakEven.toFixed(3)}</td>
                    </tr>`;
            }
        }
        if (!hasInv) invBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:var(--text-dim); font-size:0.8em;">ç›®å‰ç„¡åº«å­˜</td></tr>';
        renderLedger();
    }

    function renderLedger() {
        const list = document.getElementById('ledgerList');
        const btnMore = document.getElementById('btnLoadMore');
        list.innerHTML = '';
        
        const filteredTrades = trades.filter(t => isWithinPeriod(t.date));
        const visible = filteredTrades.slice(0, displayLimit);

        visible.forEach(t => {
            const total = (t.price || 0) * (t.qty || 0);
            let dotClass = 'dot-buy', desc = '', val = '';
            
            let convertBtn = '';
            if (t.type === 'buy' || t.type === 'use') {
                convertBtn = `<button class="btn-icon btn-convert" onclick="toggleType(${t.id})" title="è½‰">â†º</button>`;
            }

            if (t.type === 'buy') { dotClass = 'dot-buy'; desc = 'è²·å…¥ ' + t.item; val = `-${total.toFixed(0)}`; }
            else if (t.type === 'sell_trade') { dotClass = 'dot-sell'; desc = 'è³£è²¨ ' + t.item; val = `+${total.toFixed(0)}`; }
            else if (t.type === 'sell_loot') { dotClass = 'dot-loot'; desc = 'è³£å¯¶ ' + t.item; val = `+${total.toFixed(0)}`; }
            else if (t.type === 'use') { dotClass = 'dot-use'; desc = 'è‡ªç”¨ ' + t.item; val = `-${total.toFixed(0)}`; }
            else if (t.type === 'craft') { dotClass = 'dot-craft'; desc = `åˆæˆ: ${t.item} > ${t.tgtItem}`; val = t.fee > 0 ? `-${t.fee}` : '-'; }
            else if (t.type === 'convert') { dotClass = 'dot-convert'; desc = `è½‰è‡ªç”¨: ${t.item}`; val = `-${t.qty}å€‹`; }
            else if (t.type === 'cash_out') { dotClass = 'dot-cash'; desc = `å¥—ç¾: ${t.qty} é‘½ (1:${t.ratio})`; val = `+NT$${t.total}`; }

            // æœ¬åœ°æ™‚é–“é¡¯ç¤ºä¿®å¾©
            const displayDate = new Date(t.date).toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:false });

            const row = document.createElement('div');
            row.className = 'log-row';
            row.innerHTML = `
                <div>${displayDate}</div>
                <div style="font-size:0.8em;">${t.type}</div>
                <div><span class="tag-dot ${dotClass}"></span>${desc} <span style="color:#666">x${t.qty || t.tgtQty}</span></div>
                <div class="mono-num" style="text-align:right;">${val}</div>
                <div class="action-cell">
                    ${convertBtn}
                    <button onclick="delTrade(${t.id})" class="btn-icon btn-del">Ã—</button>
                </div>
            `;
            list.appendChild(row);
        });
        
        btnMore.style.display = (filteredTrades.length > displayLimit) ? 'block' : 'none';
    }

    function loadMore() { displayLimit += 20; renderLedger(); }
    function delTrade(id) { if(confirm("åˆªé™¤æ­¤ç´€éŒ„?")) { trades = trades.filter(t => t.id !== id); saveData(); renderAll(); } }
    function saveData() { localStorage.setItem('rf_trade_data', JSON.stringify(trades)); }
    function clearData() { if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.removeItem('rf_trade_data'); trades=[]; renderAll(); } }
    
    function exportData() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(trades));
        a.download = `RF_Backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); a.remove();
    }
    
    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(Array.isArray(json)) {
                    if(confirm(`åµæ¸¬åˆ° ${json.length} ç­†è³‡æ–™ï¼Œç¢ºèªé‚„åŸï¼Ÿ`)) {
                        trades = json; saveData(); renderAll(); alert("é‚„åŸæˆåŠŸ");
                    }
                }
            } catch(e) { alert("æª”æ¡ˆéŒ¯èª¤"); }
            input.value = '';
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>